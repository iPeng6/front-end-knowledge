# 浏览器是如何工作的

## 浏览器结构

浏览器主要有下面几个部分：

1. **The user interface（用户界面）**：包括地址栏、前进/后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。
2. **The browser engine（浏览器引擎）**；在用户界面和呈现引擎之间传送指令。
3. **The rendering engine（呈现引擎）**： 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。
4. **Networking（网络）**：用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。
5. **UI backend（用户界面后端）**：用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。
6. **JavaScript interpreter（JavaScript 解释器）**：用于解析和执行 JavaScript 代码。
7. **Data storage（数据存储）**：这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。浏览器也支持存储机制如 localStorage, IndexedDB, WebSQL 和 FileSystem。

![](img/browser-components.png)

Chrome 浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。

### 呈现引擎

呈现引擎一开始会从`网络层`获取请求文档的内容，然后进行如下的基本流程：

![](img/render-flow.png)

呈现引擎将开始解析 HTML 文档，并将各 elements 转化成 `DOM Tree`。同时也会解析外部 CSS 文件以及内联样式，这些带有视觉指令的样式信息将用于创建另一个树结构：`Render Tree`。

呈现树包含多个带有视觉属性（如颜色和尺寸）的矩形。这些矩形的排列顺序就是它们将在屏幕上显示的顺序。

呈现树构建完毕之后，进入“布局”处理阶段，也就是为每个节点分配一个应出现在屏幕上的确切坐标。下一个阶段是绘制 - 呈现引擎会遍历呈现树，由用户界面后端层将每个节点绘制出来。

需要着重指出的是，这是一个渐进的过程。为达到更好的用户体验，呈现引擎会力求尽快将内容显示在屏幕上。它不必等到整个 HTML 文档解析完毕之后，就会开始构建呈现树和设置布局。在不断接收和处理来自网络的其余内容的同时，呈现引擎会将部分内容解析并显示出来。

主要流程：
![](img/webkitflow.png)
